name: YouTube API (Search & Comments & Channel)

# è§¦å‘æ¡ä»¶ï¼šé€šè¿‡webhookæˆ–æ‰‹åŠ¨è§¦å‘
on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'æ¨¡å¼é€‰æ‹©'
        required: true
        default: 'search'
        type: choice
        options:
        - search
        - comments
        - channel
      search_query:
        description: 'æœç´¢å…³é”®è¯ (æœç´¢æ¨¡å¼)'
        required: false
        default: 'HONOR 400'
        type: string
      video_id:
        description: 'è§†é¢‘ID (è¯„è®ºæ¨¡å¼)'
        required: false
        type: string
      channel_handle:
        description: 'é¢‘é“Handle (é¢‘é“æ¨¡å¼ï¼Œå¦‚@JerryRigEverything)'
        required: false
        type: string
      webhook_url:
        description: 'Webhook URL (é£ä¹¦å¤šç»´è¡¨æ ¼ç­‰)'
        required: false
        type: string
      max_results:
        description: 'æœ€å¤§ç»“æœæ•°é‡ (æœç´¢æ¨¡å¼)'
        required: false
        default: '25'
        type: string
      max_comments:
        description: 'æœ€å¤§è¯„è®ºæ•°é‡ (è¯„è®ºæ¨¡å¼)'
        required: false
        default: '50'
        type: string
      max_videos:
        description: 'æœ€å¤§è§†é¢‘æ•°é‡ (é¢‘é“æ¨¡å¼)'
        required: false
        default: '50'
        type: string
      published_after:
        description: 'ç­›é€‰æ—¶é—´èŒƒå›´ï¼šä¹‹å (æœç´¢æ¨¡å¼ï¼Œæ ¼å¼: YYYY-MM-DD æˆ– YYYY-MM-DDTHH:MM:SSZ)'
        required: false
        type: string
      published_before:
        description: 'ç­›é€‰æ—¶é—´èŒƒå›´ï¼šä¹‹å‰ (æœç´¢æ¨¡å¼ï¼Œæ ¼å¼: YYYY-MM-DD æˆ– YYYY-MM-DDTHH:MM:SSZ)'
        required: false
        type: string
  
  # æ”¯æŒé€šè¿‡repository_dispatchäº‹ä»¶è§¦å‘ï¼ˆç”¨äºå¤–éƒ¨webhookï¼‰
  repository_dispatch:
    types: [youtube-search, youtube-comments, youtube-channel]

jobs:
  youtube-search:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install google-api-python-client requests httplib2 PySocks
    
    - name: æ‰§è¡ŒYouTube APIä»»åŠ¡
      env:
        YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        MODE: ${{ github.event.inputs.mode || github.event.client_payload.mode || 'search' }}
        SEARCH_QUERY: ${{ github.event.inputs.search_query || github.event.client_payload.search_query || 'HONOR 400' }}
        VIDEO_ID: ${{ github.event.inputs.video_id || github.event.client_payload.video_id }}
        CHANNEL_HANDLE: ${{ github.event.inputs.channel_handle || github.event.client_payload.channel_handle }}
        WEBHOOK_URL: ${{ github.event.inputs.webhook_url || github.event.client_payload.webhook_url }}
        MAX_RESULTS: ${{ github.event.inputs.max_results || github.event.client_payload.max_results || '25' }}
        MAX_COMMENTS: ${{ github.event.inputs.max_comments || github.event.client_payload.max_comments || '50' }}
        MAX_VIDEOS: ${{ github.event.inputs.max_videos || github.event.client_payload.max_videos || '50' }}
        PUBLISHED_AFTER: ${{ github.event.inputs.published_after || github.event.client_payload.published_after }}
        PUBLISHED_BEFORE: ${{ github.event.inputs.published_before || github.event.client_payload.published_before }}
        
      run: |
        echo "ğŸš€ å¼€å§‹æ‰§è¡ŒYouTube APIä»»åŠ¡"
        echo "æ¨¡å¼: $MODE"
        if [ "$MODE" = "search" ]; then
          echo "æœç´¢å…³é”®è¯: $SEARCH_QUERY"
          echo "æœ€å¤§ç»“æœæ•°: $MAX_RESULTS"
          python youtube_search_webhook.py search "$SEARCH_QUERY" "$MAX_RESULTS" "$YOUTUBE_API_KEY" "$WEBHOOK_URL"
        elif [ "$MODE" = "comments" ]; then
          echo "è§†é¢‘ID: $VIDEO_ID"
          echo "æœ€å¤§è¯„è®ºæ•°: $MAX_COMMENTS"
          python youtube_search_webhook.py comments "$VIDEO_ID" "$MAX_COMMENTS" "$YOUTUBE_API_KEY" "$WEBHOOK_URL"
        elif [ "$MODE" = "channel" ]; then
          echo "é¢‘é“Handle: $CHANNEL_HANDLE"
          echo "æœ€å¤§è§†é¢‘æ•°: $MAX_VIDEOS"
          echo "åˆ†æ‰¹å¤§å°: $BATCH_SIZE"
          python youtube_search_webhook.py channel "$CHANNEL_HANDLE" "$MAX_VIDEOS" "$YOUTUBE_API_KEY" "$WEBHOOK_URL"
        fi
    
    - name: ä¸Šä¼ ç»“æœæ–‡ä»¶
      if: ${{ !github.event.inputs.webhook_url && !github.event.client_payload.webhook_url }}
      uses: actions/upload-artifact@v4
      with:
        name: youtube-api-results
        path: |
          youtube_search_results_*.json
          youtube_comments_*.json
        retention-days: 30
    
    - name: è¾“å‡ºç»“æœæ‘˜è¦
      run: |
        echo "âœ… YouTube APIä»»åŠ¡å®Œæˆ"
        echo "å¦‚æœè®¾ç½®äº†Webhook URLï¼Œç»“æœå·²å‘é€åˆ°æŒ‡å®šåœ°å€"
        echo "å¦‚æœæœªè®¾ç½®Webhook URLï¼Œç»“æœå·²ä¿å­˜ä¸ºå·¥ä»¶(Artifacts)"